name: Activity types workflow
on:
  pull_request:
    types:
      - opened
  workflow_dispatch:
env:
  MAX_FILE_SIZE: 1048576 # 1 MB
  MIN_FILE_SIZE: 0 # empty file
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: output event data
        run: echo "${{ toJSON(github.event) }}"
      - name: checkout
        uses: actions/checkout@v3
      - name: Install Dependencies
        run: npm ci
      - name: Build Project
        run: npm run build
      - name: Deploy
        run: echo "Deploying..."
      - name: Check file size
        run: |
          git fetch origin ${GITHUB_BASE_REF}
          git fetch origin ${GITHUB_HEAD_REF}
          git diff --diff-filter=A --no-renames --name-only origin/develop origin/main \
          | while read FILE; do
              if ! git lfs ls-files "$FILE" &> /dev/null && [ $(wc -c < "$FILE") -gt $MAX_FILE_SIZE ]; then
                MAX_FILE_SIZE_MB=$((MAX_FILE_SIZE / 1048576))
                echo "::error file=$FILE::File size exceeds ${MAX_FILE_SIZE_MB} MB limit"
                exit 1
              fi
              if ! git lfs ls-files "$FILE" &> /dev/null && [ $(wc -c < "$FILE") -lte $MIN_FILE_SIZE ]; then
                echo "::error file=$FILE::File is empty"
                exit 1
              fi
          done
